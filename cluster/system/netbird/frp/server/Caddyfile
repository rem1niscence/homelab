{
	# The `layer4` app below must be provided by the layerâ€‘4 (caddy-l4 / layer4) plugin.
	# - It MUST be the only thing binding the real external ports (80 and 443).
	# - All other HTTP/HTTPS site blocks must bind to loopback (127.0.0.1) ports so they
	#   don't conflict with layer4. See the layer4 block below for details.
	#
	# Notes:
	# - layer4 will inspect the initial bytes of a TCP connection (HTTP Host header
	#   for :80, TLS ClientHello SNI for :443) and forward the raw TCP stream.
	# - For netbird.{$NETBIRD_DOMAIN} we forward the raw TCP stream to frps-netbird,
	#   allowing the backend (behind FRP) to terminate TLS and perform ACME as needed.
	# - For all other hosts we forward to a local HTTP/HTTPS app bound to loopback
	#   ports (127.0.0.1:8080 and 127.0.0.1:8443) so front Caddy still handles L7
	#   traffic and certificate management for those sites.
	#
	# Make sure your binary includes the module: run `caddy list-modules | grep layer4`
	# and that no other process binds :80 or :443 on the host/container.
	layer4 {
		:80 {
			# If Host header is netbird.<NETBIRD_DOMAIN>, forward raw HTTP traffic to FRP.
			@netbird http host netbird.{$NETBIRD_DOMAIN}
			route @netbird {
				proxy frps-netbird:80
			}
			# fallback -> local HTTP app (L7 handling for other hostnames)
			route {
				proxy 127.0.0.1:8080
			}
		}

		:443 {
			# If TLS SNI is netbird.<NETBIRD_DOMAIN>, forward raw TLS to FRP (passthrough).
			@netbird tls sni netbird.{$NETBIRD_DOMAIN}
			route @netbird {
				proxy frps-netbird:443
			}
			# fallback -> local HTTPS app (this Caddy process's HTTP app handles TLS for others)
			route {
				proxy 127.0.0.1:8443
			}
		}
	}
