http:
  routers:
    homarr:
      rule: Host(`{{ env "DOMAIN" }}`)
      service: homarr
      priority: 1
      tls:
        certResolver: tsresolver
    traefik:
      rule: Host(`{{ env "DOMAIN" }}`) && (PathPrefix(`/traefik`) || HeaderRegexp(`Referer`, `.*/traefik/.*`))
      priority: 2
      service: "api@internal"
      middlewares:
        - strip-prefix      
      tls:
        certResolver: "tsresolver"
    traefik-redirect:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/reverse-proxy`)
      priority: 2
      service: "api@internal"
      middlewares:
        - redirect-traefik
      tls:
        certResolver: "tsresolver"
    portainer:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/portainer`)
      service: portainer
      middlewares:
        - strip-prefix
      tls:
        certResolver: tsresolver
    grafana:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/grafana`)
      service: grafana
      middlewares:
        - strip-prefix
      tls:
        certResolver: tsresolver
    pihole:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/pihole`)
      service: pihole
      middlewares:
         - strip-prefix
      tls:
        certResolver: tsresolver
    pihole-redirect:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/pi/admin`)
      service: pihole
      middlewares:
         - redirect-pihole
      tls:
        certResolver: tsresolver
    torrent:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/torrent`)
      service: torrent
      priority: 4
      middlewares:
        - strip-prefix
      tls:
        certResolver: tsresolver  
    torrent-redirect:
      rule: Host(`{{ env "DOMAIN" }}`) && Path(`/vuetorrent`)
      service: torrent
      priority: 3
      middlewares:
        - redirect-torrent
      tls:
        certResolver: tsresolver  
    jellyfin:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/jellyfin`)
      service: jellyfin
      tls:
        certResolver: tsresolver
    jellyseerr:
      rule: Host(`{{ env "DOMAIN" }}`) && (PathPrefix(`/jellyseerr`)
      service: jellyseerr
      middlewares:
        - strip-prefix      
      tls:
        certResolver: tsresolver
    sonarr:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/sonarr`)
      service: sonarr
      tls:
        certResolver: tsresolver
    radarr:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/radarr`)
      service: radarr
      tls:
        certResolver: tsresolver
    prowlarr:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/prowlarr`)
      service: prowlarr
      tls:
        certResolver: tsresolver
    umami:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/umami`)
      service: umami
      tls:
        certResolver: tsresolver
    dashdot:
      rule: Host(`{{ env "DOMAIN" }}`) && (PathPrefix(`/dashdot`) || HeaderRegexp(`Referer`, `.*/dashdot/.*`))
      middlewares:
        - strip-prefix
      service: dashdot
      tls:
        certResolver: tsresolver
    # ---- Dashdot ------
    # This is all homarr"s fault, they"re hitting the wrong endpoints of dashdot
    dashdot-redirect:
      rule: Host(`{{ env "DOMAIN" }}`) && Path(`/dot`)
      middlewares:
        - redirect-dashdot
      service: dashdot
      tls:
        certResolver: tsresolver
    dashdot-api:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/api/modules/dashdot`)
      service: dashdot
      middlewares:
        - strip-prefix
      tls:
        certResolver: tsresolver
    dashdot-storage-api:
      rule: Host(`{{ env "DOMAIN" }}`) && PathPrefix(`/api/modules/dashdot/storage`)
      service: dashdot
      middlewares:
        - dashdot-storage-path-replace
      tls:
        certResolver: tsresolver
    # --- !Dashdot ------

  services:
    portainer:
      loadBalancer:
        servers:
          - url: "http://portainer:9000"
    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"
    pihole:
      loadBalancer:
        servers:
          - url: "http://pihole:80"
    torrent:
      loadBalancer:
        servers:
          - url: "http://qbittorrent:8080"
    umami:
      loadBalancer:
        servers:
          - url: "http://umami:3000"    
    jellyfin:
      loadBalancer:
        servers:
          - url: "http://jellyfin:8096"
    jellyseerr:
      loadBalancer:
        servers:
          - url: "http://jellyseerr:5055"
    homarr:
      loadBalancer:
        servers:
          - url: "http://homarr:7575"
    dashdot:
      loadBalancer:
        servers:
          - url: "http://dashdot:3001"
    sonarr:
      loadBalancer:
        servers:
          - url: "http://sonarr:8989"    
    radarr:
      loadBalancer:
        servers:
          - url: "http://radarr:7878"    
    prowlarr:
      loadBalancer:
        servers:
          - url: "http://prowlarr:9696"

  middlewares:
    strip-prefix:
      stripPrefix:
        prefixes:
          - /portainer
          - /grafana
          - /pihole/
          - /torrent
          - /traefik
          - /homarr
          - /dashdot
          - /api/modules/dashdot
          - /jellyseerr
    # I don"t like this either but have to do this workaround until this is fixed: https://github.com/ajnart/homarr/issues/777
    redirect-pihole:
      redirectRegex:
        regex: "^(.*)/pi/admin"
        replacement: "/pihole/admin/"
        permanent: true
    redirect-traefik:
      redirectRegex:
        regex: "^(.*)/reverse-proxy"
        replacement: "/traefik/dashboard/"
        permanent: true
    redirect-torrent:
      redirectRegex:
        regex: "^(.*)/vuetorrent"
        replacement: "/torrent/"
        permanent: true
    
    # ---- Dashdot ------
    redirect-dashdot:
      redirectRegex:
        regex: "^(.*)/dot"
        replacement: "/dashdot/"
        permanent: true
    dashdot-storage-path-replace:
      replacePath:
        path: "/load/storage"
    # --- !Dashdot ------     
    #   basicAuth:
    #     users:
    #       - "pi-admin:$apr1$pAYi7oll$NQR6hcTYFfIqBpnzpPBL91"
